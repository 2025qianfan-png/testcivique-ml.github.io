<!DOCTYPE html>
<html>
<head>
    <title>测试Supabase连接</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        .success { color: green; padding: 10px; background: #e8f5e8; border: 1px solid green; }
        .error { color: red; padding: 10px; background: #ffe8e8; border: 1px solid red; }
        .warning { color: orange; padding: 10px; background: #fff8e8; border: 1px solid orange; }
    </style>
</head>
<body>
    <h1>测试Supabase连接</h1>
    
    <div id="result">正在初始化...</div>
    
    <script>
        const SUPABASE_URL = 'https://pokwxlbntoxoxogptned.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_pu4aBS3wXF2e3ckgENTt4g_9_HvSG_v';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        async function runTests() {
            const resultDiv = document.getElementById('result');
            
            // 测试1: 基本连接
            resultDiv.innerHTML = '<h3>测试1: 基本连接...</h3>';
            
            try {
                // 测试连接
                const { data, error } = await supabase
                    .from('students')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <h4>连接失败 ❌</h4>
                            <p><strong>错误:</strong> ${error.message}</p>
                            <p><strong>代码:</strong> ${error.code}</p>
                            <p><strong>详情:</strong> ${error.details}</p>
                            <p><strong>提示:</strong> ${error.hint || '无'}</p>
                        </div>
                    `;
                    
                    // 如果是表不存在错误
                    if (error.code === 'PGRST116') {
                        resultDiv.innerHTML += `
                            <div class="warning">
                                <h4>表不存在</h4>
                                <p>students表尚未创建。</p>
                                <p>请在Supabase SQL编辑器中运行建表SQL。</p>
                            </div>
                        `;
                    }
                    
                    return;
                }
                
                resultDiv.innerHTML += `
                    <div class="success">
                        <h4>连接成功 ✓</h4>
                        <p>Supabase连接正常</p>
                        <p>students表存在</p>
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="error">
                        <h4>异常错误 ❌</h4>
                        <p>${error.message}</p>
                    </div>
                `;
                return;
            }
            
            // 测试2: 读取数据
            resultDiv.innerHTML += '<h3>测试2: 读取学生数据...</h3>';
            
            try {
                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .limit(5);
                
                if (error) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <h4>读取失败 ❌</h4>
                            <p>错误: ${error.message}</p>
                        </div>
                    `;
                    return;
                }
                
                if (data.length === 0) {
                    resultDiv.innerHTML += `
                        <div class="warning">
                            <h4>数据为空</h4>
                            <p>students表中没有数据。</p>
                            <p>请插入测试数据。</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="success">
                            <h4>数据读取成功 ✓</h4>
                            <p>找到 ${data.length} 条记录</p>
                            <h4>学生列表:</h4>
                            <ul>
                                ${data.map(student => `
                                    <li>${student.name} - ${student.type} - ${student.timer ? new Date(student.timer).toLocaleDateString() : '无期限'}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="error">
                        <h4>读取异常 ❌</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
            
            // 测试3: 验证登录
            resultDiv.innerHTML += '<h3>测试3: 测试登录验证...</h3>';
            
            try {
                // 测试一个存在的用户
                const testName = 'peng.gao';
                const testPassword = 'peng2026';
                
                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .eq('name', testName)
                    .eq('password', testPassword)
                    .single();
                
                if (error) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <h4>登录测试失败 ❌</h4>
                            <p>错误: ${error.message}</p>
                            <p>尝试登录 ${testName} 失败</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="success">
                            <h4>登录测试成功 ✓</h4>
                            <p>用户 ${testName} 验证成功</p>
                            <p>类型: ${data.type}</p>
                            <p>到期: ${data.timer ? new Date(data.timer).toLocaleDateString() : '无期限'}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="error">
                        <h4>登录测试异常 ❌</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // 页面加载时运行测试
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
