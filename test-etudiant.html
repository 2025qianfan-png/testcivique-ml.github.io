<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Étudiant Civique - Association Mille Voiles</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Variables et reset */
:root {
  --primary-blue: #004080;
  --primary-light-blue: #0066cc;
  --primary-yellow: #ffd633;
  --primary-light-yellow: #ffe066;
  --dark-gray: #333333;
  --medium-gray: #666666;
  --light-gray: #f5f7fa;
  --white: #ffffff;
  --green: #27ae60;
  --red: #e74c3c;
  --orange: #f39c12;
  --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  --shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.12);
  --border-radius: 12px;
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Open Sans', sans-serif;
  color: var(--dark-gray);
  background-color: var(--light-gray);
  line-height: 1.7;
}

h1, h2, h3, h4 {
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  line-height: 1.3;
  color: var(--primary-blue);
}

.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.btn {
  display: inline-block;
  padding: 16px 36px;
  background-color: var(--primary-yellow);
  color: var(--primary-blue);
  border: none;
  border-radius: 50px;
  font-weight: 600;
  font-size: 1.1rem;
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
  font-family: 'Montserrat', sans-serif;
  box-shadow: var(--shadow);
}

.btn:hover {
  background-color: var(--primary-light-yellow);
  transform: translateY(-3px);
  box-shadow: var(--shadow-hover);
}

.btn-primary {
  background-color: var(--primary-blue);
  color: var(--white);
}

.btn-primary:hover {
  background-color: var(--primary-light-blue);
}

.btn-success {
  background-color: var(--green);
  color: var(--white);
}

.btn-success:hover {
  background-color: #229954;
}

/* Custom Alert Modal */
.alert-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  z-index: 4000;
  display: none;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.alert-content {
  background-color: var(--white);
  padding: 40px;
  border-radius: var(--border-radius);
  max-width: 600px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalFade 0.4s ease-out;
  text-align: center;
}

@keyframes modalFade {
  from { opacity: 0; transform: translateY(-30px); }
  to { opacity: 1; transform: translateY(0); }
}

.alert-icon {
  font-size: 4rem;
  margin-bottom: 20px;
}

.alert-icon.success {
  color: var(--green);
}

.alert-icon.warning {
  color: var(--orange);
}

.alert-icon.error {
  color: var(--red);
}

.alert-icon.info {
  color: var(--primary-blue);
}

.alert-content h2 {
  font-size: 1.8rem;
  margin-bottom: 15px;
  color: var(--primary-blue);
}

.alert-content p {
  margin-bottom: 25px;
  color: var(--medium-gray);
  font-size: 1.1rem;
  line-height: 1.6;
}

.alert-btns {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 25px;
}

/* Login Modal */
.login-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.85);
  z-index: 3000;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
  overflow-y: auto;
}

.login-content {
  background-color: var(--white);
  padding: 30px;
  border-radius: var(--border-radius);
  max-width: 500px;
  width: 100%;
  margin: 40px auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalFade 0.4s ease-out;
}

.login-content h2 {
  font-size: 1.8rem;
  margin-bottom: 15px;
  color: var(--primary-blue);
  text-align: center;
}

.login-content p {
  margin-bottom: 20px;
  color: var(--medium-gray);
  font-size: 1rem;
  text-align: center;
}

.login-form {
  text-align: left;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--primary-blue);
}

.form-group input {
  width: 100%;
  padding: 14px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-family: 'Open Sans', sans-serif;
  font-size: 16px;
  transition: var(--transition);
}

.form-group input:focus {
  outline: none;
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1);
}

.form-error {
  color: var(--red);
  margin-top: 10px;
  font-weight: 600;
  display: none;
  font-size: 0.9rem;
}

.login-btns {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 25px;
}

.btn-modal {
  padding: 14px 30px;
  min-width: 140px;
}

/* Test Selection Modal */
.selection-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.85);
  z-index: 3001;
  display: none;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.selection-content {
  background-color: var(--white);
  padding: 40px;
  border-radius: var(--border-radius);
  max-width: 1100px;
  width: 100%;
  margin: 0 auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalFade 0.4s ease-out;
}

.selection-content h2 {
  font-size: 2rem;
  margin-bottom: 30px;
  color: var(--primary-blue);
  text-align: center;
}

.selection-content p {
  margin-bottom: 30px;
  color: var(--medium-gray);
  font-size: 1.1rem;
  text-align: center;
}

/* Test Type Cards - Three columns side by side */
.test-types-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 25px;
  margin-bottom: 30px;
}

.test-type-card {
  background-color: var(--white);
  border: 2px solid #e0e0e0;
  border-radius: var(--border-radius);
  padding: 25px;
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  position: relative;
}

.test-type-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-hover);
}

.test-type-card.allowed {
  border-color: var(--primary-blue);
  cursor: pointer;
}

.test-type-card.allowed:hover {
  border-color: var(--primary-light-blue);
  background-color: rgba(0, 64, 128, 0.05);
}

.test-type-card.disabled {
  opacity: 0.6;
  cursor: not-allowed;
  background-color: #f5f5f5;
  border-color: #cccccc;
}

.test-type-card.disabled:hover {
  transform: none;
  box-shadow: none;
}

.test-type-card.disabled::after {
  content: "⛔";
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 1.2rem;
}

.test-type-icon {
  font-size: 3rem;
  margin-bottom: 20px;
}

.test-type-card.allowed .test-type-icon {
  color: var(--primary-blue);
}

.test-type-card.disabled .test-type-icon {
  color: var(--medium-gray);
}

.test-type-card h3 {
  font-size: 1.5rem;
  margin-bottom: 15px;
  color: var(--primary-blue);
  text-align: center;
}

.test-type-card.disabled h3 {
  color: var(--medium-gray);
}

.test-type-card p {
  font-size: 1rem;
  margin-bottom: 15px;
  text-align: center;
  color: var(--medium-gray);
  flex-grow: 1;
}

.test-info {
  background-color: var(--light-gray);
  padding: 12px;
  border-radius: 8px;
  margin-top: 15px;
  width: 100%;
  text-align: left;
  font-size: 0.9rem;
}

.test-type-card.disabled .test-info {
  background-color: #e9e9e9;
  color: #888;
}

.test-info-item {
  display: flex;
  align-items: flex-start;
  margin-bottom: 8px;
}

.test-info-item i {
  margin-right: 10px;
  color: var(--primary-blue);
  margin-top: 2px;
}

.test-type-card.disabled .test-info-item i {
  color: #888;
}

/* Test Container */
.test-container {
  display: none;
}

.test-container.show {
  display: block;
}

/* Timer */
.timer-container {
  background-color: var(--white);
  padding: 20px;
  border-radius: var(--border-radius);
  margin-bottom: 30px;
  box-shadow: var(--shadow);
  text-align: center;
}

.timer-display {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--primary-blue);
  margin-bottom: 10px;
  font-family: 'Montserrat', sans-serif;
}

.timer-label {
  font-size: 1.1rem;
  color: var(--medium-gray);
  margin-bottom: 15px;
}

.timer-progress {
  height: 10px;
  background-color: #e0e0e0;
  border-radius: 5px;
  overflow: hidden;
  margin-top: 15px;
}

.timer-progress-fill {
  height: 100%;
  background-color: var(--primary-blue);
  width: 100%;
  transition: width 1s linear;
}

.timer-warning {
  color: var(--orange);
  font-weight: 600;
  margin-top: 10px;
  display: none;
}

.timer-critical {
  color: var(--red);
  font-weight: 600;
  margin-top: 10px;
  display: none;
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

/* Question Counter */
.question-counter {
  background-color: var(--white);
  padding: 20px;
  border-radius: var(--border-radius);
  margin-bottom: 30px;
  box-shadow: var(--shadow);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.counter-info {
  display: flex;
  align-items: center;
  gap: 20px;
}

.progress-container {
  flex-grow: 1;
  max-width: 400px;
}

.progress-bar {
  height: 10px;
  background-color: #e0e0e0;
  border-radius: 5px;
  overflow: hidden;
  margin-top: 5px;
}

.progress-fill {
  height: 100%;
  background-color: var(--primary-blue);
  width: 0%;
  transition: width 0.5s ease;
}

/* Question Card */
.question-card {
  background-color: var(--white);
  border-radius: var(--border-radius);
  padding: 40px;
  margin-bottom: 30px;
  box-shadow: var(--shadow);
  transition: var(--transition);
}

.question-text {
  font-size: 1.4rem;
  margin-bottom: 30px;
  color: var(--primary-blue);
  font-weight: 600;
}

/* Options with ABCD labels */
.options-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 30px;
}

.option {
  display: flex;
  align-items: flex-start;
  padding: 18px 20px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  cursor: pointer;
  transition: var(--transition);
  background-color: #f9f9f9;
}

.option:hover {
  background-color: #f0f7ff;
  border-color: var(--primary-light-blue);
}

.option.selected {
  background-color: #e6f2ff;
  border-color: var(--primary-blue);
}

.option-letter {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 30px;
  height: 30px;
  background-color: var(--primary-blue);
  color: white;
  border-radius: 50%;
  font-weight: bold;
  margin-right: 15px;
  flex-shrink: 0;
  font-family: 'Montserrat', sans-serif;
}

.option input {
  display: none;
}

.option label {
  cursor: pointer;
  font-size: 1.1rem;
  flex-grow: 1;
  display: flex;
  align-items: flex-start;
}

/* Navigation */
.navigation-btns {
  display: flex;
  justify-content: space-between;
  margin-top: 40px;
  gap: 20px;
}

.nav-btn {
  padding: 14px 30px;
  min-width: 150px;
}

.nav-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Results */
.results-container {
  display: none;
}

.results-container.show {
  display: block;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.results-content {
  background-color: var(--white);
  border-radius: var(--border-radius);
  padding: 50px;
  margin-top: 40px;
  box-shadow: var(--shadow);
  text-align: center;
}

.results-header {
  margin-bottom: 40px;
}

.score-display {
  font-size: 4rem;
  font-weight: 800;
  color: var(--primary-blue);
  margin-bottom: 10px;
}

.score-text {
  font-size: 1.8rem;
  margin-bottom: 30px;
}

.score-bar {
  height: 20px;
  background-color: #e0e0e0;
  border-radius: 10px;
  overflow: hidden;
  margin: 30px 0;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}

.score-fill {
  height: 100%;
  background-color: var(--green);
  width: 0%;
  transition: width 1.5s ease;
}

/* Theme Performance Charts */
.theme-performance {
  margin: 40px 0;
  text-align: left;
}

.theme-performance h3 {
  font-size: 1.5rem;
  margin-bottom: 25px;
  color: var(--primary-blue);
  text-align: center;
}

.theme-charts-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.theme-chart-item {
  background-color: var(--light-gray);
  padding: 20px;
  border-radius: var(--border-radius);
}

.theme-chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.theme-name {
  font-weight: 600;
  color: var(--primary-blue);
  font-size: 1.1rem;
}

.theme-score {
  font-weight: 600;
  color: var(--dark-gray);
}

.theme-chart-bar {
  height: 20px;
  background-color: #e0e0e0;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.theme-chart-fill {
  height: 100%;
  position: absolute;
  left: 0;
  top: 0;
  border-radius: 10px;
  transition: width 1s ease;
}

.theme-chart-fill.excellent {
  background-color: var(--green);
}

.theme-chart-fill.good {
  background-color: #2ecc71;
}

.theme-chart-fill.average {
  background-color: #f1c40f;
}

.theme-chart-fill.poor {
  background-color: #e74c3c;
}

.theme-chart-fill.very-poor {
  background-color: #c0392b;
}

.theme-chart-details {
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
  color: var(--medium-gray);
  margin-top: 5px;
}

/* Question Map */
.question-map-container {
  background-color: var(--light-gray);
  padding: 25px;
  border-radius: var(--border-radius);
  margin: 40px 0;
}

.question-map-container h3 {
  font-size: 1.5rem;
  margin-bottom: 20px;
  color: var(--primary-blue);
  text-align: center;
}

.question-map {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.map-item {
  width: 100%;
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  font-size: 1rem;
  border: 2px solid transparent;
}

.map-item:hover {
  transform: scale(1.05);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.map-item.unanswered {
  background-color: #f0f0f0;
  color: var(--medium-gray);
}

.map-item.correct {
  background-color: var(--green);
  color: white;
}

.map-item.incorrect {
  background-color: var(--red);
  color: white;
}

.map-item.current {
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 2px var(--primary-blue);
}

.map-legend {
  display: flex;
  justify-content: center;
  gap: 25px;
  font-size: 0.9rem;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.legend-color {
  width: 15px;
  height: 15px;
  border-radius: 3px;
}

.legend-color.unanswered {
  background-color: #f0f0f0;
}

.legend-color.correct {
  background-color: var(--green);
}

.legend-color.incorrect {
  background-color: var(--red);
}

/* Question Review */
.question-review-container {
  background-color: var(--white);
  border-radius: var(--border-radius);
  padding: 30px;
  margin: 30px 0;
  box-shadow: var(--shadow);
  display: none;
}

.question-review-container.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--light-gray);
}

.review-header h4 {
  font-size: 1.3rem;
  color: var(--primary-blue);
  margin: 0;
}

.review-question {
  font-size: 1.2rem;
  margin-bottom: 25px;
  color: var(--dark-gray);
  font-weight: 600;
  line-height: 1.5;
}

.review-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 25px;
}

.review-option {
  display: flex;
  align-items: flex-start;
  padding: 15px;
  border-radius: 8px;
  border: 2px solid #e0e0e0;
  position: relative;
}

.review-option.correct-answer {
  border-color: var(--green);
  background-color: rgba(39, 174, 96, 0.05);
}

.review-option.user-answer {
  border-color: var(--primary-blue);
  background-color: rgba(0, 64, 128, 0.05);
}

.review-option.user-answer.incorrect {
  border-color: var(--red);
  background-color: rgba(231, 76, 60, 0.05);
}

.review-option-label {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 25px;
  height: 25px;
  background-color: var(--primary-blue);
  color: white;
  border-radius: 50%;
  font-weight: bold;
  margin-right: 12px;
  flex-shrink: 0;
  font-size: 0.9rem;
}

.review-option.correct-answer .review-option-label {
  background-color: var(--green);
}

.review-option.user-answer.incorrect .review-option-label {
  background-color: var(--red);
}

.review-option-text {
  flex-grow: 1;
  font-size: 1rem;
}

.review-option-badge {
  position: absolute;
  top: -10px;
  right: 10px;
  background-color: var(--green);
  color: white;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
}

.review-option.user-answer .review-option-badge {
  background-color: var(--primary-blue);
}

.review-option.user-answer.incorrect .review-option-badge {
  background-color: var(--red);
}

.review-explanation {
  background-color: rgba(255, 214, 51, 0.1);
  padding: 20px;
  border-radius: 8px;
  margin-top: 20px;
  border-left: 4px solid var(--primary-yellow);
}

.review-explanation h5 {
  color: var(--primary-blue);
  margin-bottom: 10px;
  font-size: 1.1rem;
}

.review-explanation p {
  color: var(--dark-gray);
  line-height: 1.6;
}

.results-actions {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 50px;
  flex-wrap: wrap;
}

/* Footer */
.test-footer {
  background-color: var(--primary-blue);
  color: var(--white);
  padding: 40px 0;
  margin-top: 80px;
  text-align: center;
  display: none;
}

.test-footer a {
  color: var(--primary-yellow);
  font-weight: 600;
}

/* Loading Spinner */
.loading-spinner {
  display: none;
  text-align: center;
  padding: 30px;
}

.spinner {
  border: 5px solid #f3f3f3;
  border-top: 5px solid var(--primary-blue);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 烟花和心碎动画效果 */
@keyframes fireworks {
  0% { transform: scale(0.8); opacity: 0.5; }
  50% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

@keyframes heartbreak {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(-15deg); }
  75% { transform: rotate(15deg); }
  100% { transform: rotate(0deg); }
}

.fireworks {
  animation: fireworks 1s ease-in-out 3;
}

.heartbreak {
  animation: heartbreak 0.5s ease-in-out 3;
}

/* 剩余天数信息样式 */
.days-left-info {
  background-color: rgba(0, 100, 255, 0.1);
  border-left: 4px solid var(--primary-blue);
  padding: 15px;
  border-radius: 0 8px 8px 0;
  margin: 15px 0;
  font-size: 1rem;
}

.days-left-info i {
  color: var(--primary-blue);
  margin-right: 10px;
}

/* Responsive */
@media (max-width: 1024px) {
  .test-types-container {
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }
}

@media (max-width: 768px) {
  .test-types-container {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .selection-content {
    padding: 25px 20px;
    margin: 20px auto;
  }
  
  .selection-content h2 {
    font-size: 1.5rem;
  }
  
  .login-content {
    padding: 25px 20px;
    margin: 30px auto;
  }
  
  .login-content h2 {
    font-size: 1.5rem;
  }
  
  .question-map {
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
  }
  
  .map-item {
    font-size: 0.9rem;
  }
  
  .question-card {
    padding: 25px;
  }
  
  .question-text {
    font-size: 1.2rem;
  }
  
  .option {
    padding: 15px;
  }
  
  .option-letter {
    width: 25px;
    height: 25px;
    font-size: 0.9rem;
  }
  
  .results-content {
    padding: 30px 20px;
  }
  
  .score-display {
    font-size: 3rem;
  }
  
  .navigation-btns {
    flex-direction: column;
  }
  
  .nav-btn {
    width: 100%;
  }
  
  .login-btns {
    flex-direction: column;
  }
  
  .btn-modal {
    width: 100%;
  }
  
  .timer-display {
    font-size: 2rem;
  }
  
  .theme-charts-container {
    gap: 15px;
  }
  
  .theme-chart-item {
    padding: 15px;
  }
}

@media (max-width: 480px) {
  .question-map {
    grid-template-columns: repeat(5, 1fr);
  }
  
  .map-legend {
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  
  .selection-content {
    padding: 20px 15px;
  }
  
  .login-content {
    padding: 20px 15px;
  }
  
  .login-content h2 {
    font-size: 1.3rem;
  }
  
  .form-group input {
    padding: 12px;
  }
  
  .results-actions {
    flex-direction: column;
  }
  
  .results-actions .btn {
    width: 100%;
    margin-bottom: 10px;
  }
  
  .score-display {
    font-size: 2.5rem;
  }
  
  .score-text {
    font-size: 1.3rem;
  }
  
  .alert-content {
    padding: 25px;
  }
  
  .alert-icon {
    font-size: 3rem;
  }
}
</style>
</head>
<body>

<!-- Custom Alert Modal -->
<div id="alertModal" class="alert-overlay">
  <div class="alert-content">
    <div class="alert-icon info" id="alertIcon">
      <i class="fas fa-info-circle"></i>
    </div>
    <h2 id="alertTitle">Information</h2>
    <p id="alertMessage">Message d'information</p>
    <div class="alert-btns">
      <button class="btn btn-primary" onclick="closeAlert()">OK</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="login-overlay">
  <div class="login-content">
    <h2>Accès Test Étudiant</h2>
    <p>Veuillez entrer vos informations d'étudiant</p>
    
    <form id="loginForm" class="login-form">
      <div class="form-group">
        <label for="studentName">Nom de l'étudiant *</label>
        <input type="text" id="studentName" placeholder="Votre nom complet" required>
      </div>
      
      <div class="form-group">
        <label for="studentPassword">Mot de passe *</label>
        <input type="password" id="studentPassword" placeholder="Mot de passe fourni" required>
        <div class="form-error" id="loginError">Nom ou mot de passe incorrect</div>
      </div>
      
      <div style="background-color: rgba(243,156,18,0.1); border-left: 4px solid var(--orange); padding: 12px; border-radius: 0 8px 8px 0; margin: 20px 0; font-size: 0.9rem;">
        <p><i class="fas fa-info-circle"></i> Tous les tests : 40 questions - 45 minutes</p>
        <p><i class="fas fa-check-circle"></i> Seuil de réussite : 32/40 (80%)</p>
      </div>
    </form>
    
    <div class="loading-spinner" id="loginSpinner" style="display: none;">
      <div class="spinner"></div>
      <p>Connexion en cours...</p>
    </div>
    
    <div class="login-btns" id="loginButtons">
      <button class="btn btn-primary btn-modal" onclick="validateLogin()">
        <i class="fas fa-sign-in-alt"></i> Se connecter
      </button>
      <button class="btn btn-modal" onclick="goBackToHome()">
        <i class="fas fa-home"></i> Accueil
      </button>
    </div>
  </div>
</div>

<!-- Test Selection Modal -->
<div id="selectionModal" class="selection-overlay">
  <div class="selection-content">
    <h2>Choisissez votre test</h2>
    <p id="selectionMessage">Cliquez sur une option pour commencer immédiatement</p>
    
    <!-- 剩余天数信息显示区域 -->
    <div id="daysLeftInfo" class="days-left-info" style="display: none;">
      <p><i class="fas fa-calendar-check"></i> <span id="daysLeftText">Votre accès est valide pour X jours.</span></p>
    </div>
    
    <div class="test-types-container">
      <!-- Test for multi-year residence permit -->
      <div class="test-type-card" id="multiYearCard" onclick="startTestIfAllowed('multi_year')">
        <div class="test-type-icon">
          <i class="fas fa-passport"></i>
        </div>
        <h3>Titre de Séjour 2-4 Ans</h3>
        <div class="test-info">
          <div class="test-info-item">
            <i class="fas fa-users"></i>
            <span><strong>适用人群 / Public visé：</strong></span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-user-graduate"></i>
            <span>学生签证转工作签证 / Étudiants en reconversion professionnelle</span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-file-contract"></i>
            <span>首次申请多年居留 / Première demande de titre pluriannuel</span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-passport"></i>
            <span>专业人才护照持有者 / Titulaires de passeport talent</span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-briefcase"></i>
            <span>工作合同续签者 / Renouvellement de contrat de travail</span>
          </div>
        </div>
      </div>
      
      <!-- Test for 10-year residence card -->
      <div class="test-type-card" id="tenYearCard" onclick="startTestIfAllowed('ten_year')">
        <div class="test-type-icon">
          <i class="fas fa-id-card-alt"></i>
        </div>
        <h3>Carte de Résident 10 Ans</h3>
        <div class="test-info">
          <div class="test-info-item">
            <i class="fas fa-users"></i>
            <span><strong>适用人群 / Public visé：</strong></span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-calendar-alt"></i>
            <span>在法国连续居住满5年 / Résidence continue en France depuis 5 ans</span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-heart"></i>
            <span>法籍人士的配偶 / Conjoint(e) de citoyen(ne) français(e)</span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-shield-alt"></i>
            <span>难民身份获得批准者 / Réfugiés statutaires</span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-user-tie"></i>
            <span>长期工作合同持有者 / Titulaires de CDI longue durée</span>
          </div>
        </div>
      </div>
      
      <!-- Test for French nationality -->
      <div class="test-type-card" id="nationalityCard" onclick="startTestIfAllowed('nationality')">
        <div class="test-type-icon">
          <i class="fas fa-flag"></i>
        </div>
        <h3>Nationalité Française</h3>
        <div class="test-info">
          <div class="test-info-item">
            <i class="fas fa-users"></i>
            <span><strong>适用人群 / Public visé：</strong></span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-home"></i>
            <span>在法国合法居住满5年 / Résidence légale en France depuis 5 ans</span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-language"></i>
            <span>法语水平达到B1及以上 / Niveau de français B1 ou supérieur</span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-balance-scale"></i>
            <span>无犯罪记录且完税证明 / Casier judiciaire vierge et impôts à jour</span>
          </div>
          <div class="test-info-item">
            <i class="fas fa-hands-helping"></i>
            <span>与法国社会文化深度融入 / Intégration approfondie à la société française</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="login-btns">
      <button class="btn btn-modal" onclick="goBackToLogin()">
        <i class="fas fa-sign-out-alt"></i> Changer d'utilisateur
      </button>
    </div>
  </div>
</div>

<!-- Test Header -->
<header class="test-header" style="display: none;">
  <div class="container">
    <h1 id="testTitle">Test Civique</h1>
    <p id="testSubtitle">40 questions - 45 minutes</p>
    <div class="header-actions">
      <button class="btn" onclick="showInstructions()">
        <i class="fas fa-info-circle"></i> Instructions
      </button>
      <button class="btn" onclick="restartTest()">
        <i class="fas fa-redo"></i> Recommencer
      </button>
      <button class="btn btn-primary" onclick="goBackToHome()">
        <i class="fas fa-home"></i> Accueil
      </button>
    </div>
  </div>
</header>

<!-- Test Container -->
<main class="container">
  <div id="testContainer" class="test-container">
    <!-- Timer -->
    <div class="timer-container">
      <div class="timer-display" id="timerDisplay">45:00</div>
      <div class="timer-label">Temps restant</div>
      <div class="timer-progress">
        <div class="timer-progress-fill" id="timerProgress"></div>
      </div>
      <div class="timer-warning" id="timerWarning">
        <i class="fas fa-exclamation-triangle"></i> Plus que 10 minutes!
      </div>
      <div class="timer-critical" id="timerCritical">
        <i class="fas fa-skull-crossbones"></i> Dernières 5 minutes!
      </div>
    </div>
    
    <!-- Question Counter -->
    <div class="question-counter">
      <div class="counter-info">
        <div>
          <h3>Question <span id="currentQuestion">1</span> sur <span id="totalQuestions">40</span></h3>
          <p id="testTypeInfo">Test en cours</p>
        </div>
        <div class="progress-container">
          <div>Progression: <span id="progressPercent">0%</span></div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Question -->
    <div class="question-card">
      <div class="question-text" id="questionText">Chargement de la question...</div>
      
      <div class="options-container" id="optionsContainer">
        <!-- Options will be inserted here by JavaScript -->
      </div>
      
      <div class="navigation-btns">
        <button class="btn nav-btn" id="prevBtn" onclick="previousQuestion()" disabled>
          <i class="fas fa-arrow-left"></i> Précédente
        </button>
        <button class="btn btn-primary nav-btn" id="nextBtn" onclick="nextQuestion()">
          Suivante <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>
    
    <!-- Submit Button -->
    <div style="text-align: center; margin-top: 40px;">
      <button class="btn btn-primary" id="submitBtn" onclick="submitTest()" style="padding: 18px 50px; font-size: 1.2rem; display: none;">
        <i class="fas fa-paper-plane"></i> Terminer le test
      </button>
    </div>
  </div>
  
  <!-- Results Container -->
  <div id="resultsContainer" class="results-container">
    <div class="results-content">
      <div class="results-header">
        <!-- 修正：显示总分 -->
        <div class="score-display" id="scoreDisplay">0/40</div>
        <div class="score-text" id="scoreText">Chargement du résultat...</div>
        
        <!-- 修正：显示进度条 -->
        <div class="score-bar">
          <div class="score-fill" id="scoreFill"></div>
        </div>
      </div>
      
      <!-- Theme Performance Charts -->
      <div class="theme-performance" id="themePerformance">
        <h3>Performance par Thème</h3>
        <div class="theme-charts-container" id="themeChartsContainer">
          <!-- Charts will be inserted here by JavaScript -->
        </div>
      </div>
      
      <!-- Question Map -->
      <div class="question-map-container" id="questionMapContainer">
        <h3>Carte des Réponses</h3>
        <div class="question-map" id="questionMap">
          <!-- Question map will be inserted here by JavaScript -->
        </div>
        <div class="map-legend">
          <div class="legend-item">
            <div class="legend-color unanswered"></div>
            <span>Non répondue</span>
          </div>
          <div class="legend-item">
            <div class="legend-color correct"></div>
            <span>Correcte</span>
          </div>
          <div class="legend-item">
            <div class="legend-color incorrect"></div>
            <span>Incorrecte</span>
          </div>
        </div>
      </div>
      
      <!-- Question Review -->
      <div class="question-review-container" id="questionReview">
        <!-- Question review will be inserted here when user clicks on map -->
      </div>
      
      <div class="results-actions">
        <button class="btn" onclick="restartTest()">
          <i class="fas fa-redo"></i> Nouveau test
        </button>
        <button class="btn btn-primary" onclick="goBackToHome()">
          <i class="fas fa-home"></i> Accueil
        </button>
      </div>
    </div>
  </div>
</main>

<!-- Footer -->
<footer class="test-footer">
  <div class="container">
    <p>© 2026 Association Mille Voiles</p>
    <p id="footerTestInfo">Test civique - Simulation officielle</p>
    <p><a href="index.html">Retour au site principal</a></p>
  </div>
</footer>

<script src="compte.js"></script>
<script src="question_multia.js"></script>
<script src="question_resident.js"></script>

<script>
// ==================== 全局配置 ====================
// 禁止右键
document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
});

// 禁止常见快捷键
document.addEventListener('keydown', function (e) {
    if (e.ctrlKey && ['c', 'u', 's', 'x', 'v', 'a'].includes(e.key.toLowerCase())) {
        e.preventDefault();
    }
    if (e.key === 'F12') {
        e.preventDefault();
    }
});

// ==================== 主题分布配置 ====================
const themeDistribution = {
    "Accès aux soins": 1,
    "Autorité parentale et système éducatif": 1,
    "Devise et symboles de la République": 3,
    "Droits fondamentaux": 2,
    "Démocratie et droit de vote": 3,
    "Grandes périodes et personnages historiques": 3,
    "Institutions": 2,
    "Laïcité": 2,
    "Mises en situation": 12,
    "Obligations et devoirs des personnes résidant en France": 3,
    "Patrimoine français": 2,
    "S'installer et résider en France": 1,
    "Territoires et géographie": 3,
    "Travail": 1,
    "UnionEuropéenne": 1
};

// ==================== 测试类型配置 ====================
const testTypes = {
    multi_year: {
        name: "Titre de Séjour 2-4 Ans",
        threshold: 32,
        duration: 45,
        description: "Test pour titre de séjour pluriannuel",
        source: "multi_only"
    },
    ten_year: {
        name: "Carte de Résident 10 Ans",
        threshold: 32,
        duration: 45,
        description: "Test pour carte de résident de 10 ans",
        source: "both"
    },
    nationality: {
        name: "Nationalité Française",
        threshold: 32,
        duration: 45,
        description: "Test pour accès à la nationalité française",
        source: "both"
    }
};

// ==================== 全局变量 ====================
let selectedTestType = null;
let studentInfo = { name: "", testDate: "", testType: "", type: "", daysLeft: 0 };
let selectedQuestions = [];
let currentQuestionIndex = 0;
let userAnswers = [];

let totalTime = 45 * 60;
let timeLeft = totalTime;
let timerInterval = null;

let currentScore = 0;
let currentPercentage = 0;
let currentScoreText = "";

let allQuestions = [];
let themePerformance = {}; // 存储每个主题的表现

// ==================== 自定义提示窗口 ====================
function showAlert(title, message, type = 'info') {
    const alertModal = document.getElementById('alertModal');
    const alertTitle = document.getElementById('alertTitle');
    const alertMessage = document.getElementById('alertMessage');
    const alertIcon = document.getElementById('alertIcon');
    
    // 设置标题和消息
    alertTitle.textContent = title;
    alertMessage.textContent = message;
    
    // 设置图标类型
    alertIcon.className = 'alert-icon';
    switch(type) {
        case 'success':
            alertIcon.classList.add('success');
            alertIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            break;
        case 'warning':
            alertIcon.classList.add('warning');
            alertIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            break;
        case 'error':
            alertIcon.classList.add('error');
            alertIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
            break;
        case 'info':
        default:
            alertIcon.classList.add('info');
            alertIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            break;
    }
    
    // 显示窗口
    alertModal.style.display = 'flex';
}

function closeAlert() {
    document.getElementById('alertModal').style.display = 'none';
}

// ==================== 登录验证 ====================
function validateLogin() {
    console.log("登录按钮被点击");
    
    const name = document.getElementById('studentName').value.trim();
    const password = document.getElementById('studentPassword').value.trim();
    const loginError = document.getElementById('loginError');
    const loadingSpinner = document.getElementById('loginSpinner');
    const loginButtons = document.getElementById('loginButtons');
    
    if (!name || !password) {
        showAlert("Champs requis", "Veuillez remplir tous les champs.", 'warning');
        return;
    }
    
    if (typeof students === 'undefined') {
        showAlert("Erreur de chargement", "Fichier des étudiants non chargé. Vérifiez compte.js", 'error');
        return;
    }
    
    // 查找匹配的学生
    const student = students.find(s => 
        s.name.toLowerCase() === name.toLowerCase() && 
        s.password === password
    );
    
    if (!student) {
        loginError.style.display = 'block';
        return;
    }
    
    // ==================== 检查用户使用时限 ====================
    if (student.timer) {
        const expiryDate = new Date(student.timer);
        const currentDate = new Date();
        
        // 如果到期日小于当前日期，说明已过期
        if (expiryDate < currentDate) {
            showAlert("Accès expiré", 
                "Votre période d'accès a expiré le " + student.timer + 
                "\n\nVeuillez contacter l'administrateur pour renouveler votre accès.", 
                'error');
            loginError.textContent = "Votre période d'accès a expiré";
            loginError.style.display = 'block';
            return;
        } else {
            // 计算剩余天数
            const timeDiff = expiryDate - currentDate;
            const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            
            // 存储剩余天数到studentInfo
            studentInfo.daysLeft = daysLeft;
            
            // 显示剩余天数信息
            console.log(`学生 ${name} 还有 ${daysLeft} 天可用`);
        }
    } else {
        // 如果没有设置timer，默认为长期有效
        studentInfo.daysLeft = -1; // -1表示长期有效
    }
    // ==================== 时限检查结束 ====================
    
    // 检查学生类型
    if (!student.type) {
        showAlert("Erreur de compte", "Type d'étudiant non défini dans le compte.", 'error');
        return;
    }
    
    // 记录学生信息
    studentInfo.name = name;
    studentInfo.testDate = new Date().toLocaleString('fr-FR');
    studentInfo.type = student.type;
    
    loginError.style.display = 'none';
    loginButtons.style.display = 'none';
    loadingSpinner.style.display = 'block';
    
    setTimeout(() => {
        try {
            if (typeof question_multi === 'undefined') {
                throw new Error("题库 question_multi.js 未加载");
            }
            
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('selectionModal').style.display = 'flex';
            
            // 根据学生类型设置卡片权限状态
            updateTestCardPermissions();
            
            // 显示剩余天数信息
            showDaysLeftInfo();
            
        } catch (error) {
            console.error("登录失败:", error);
            showAlert("Erreur de connexion", error.message || "Erreur lors de la connexion.", 'error');
        } finally {
            loadingSpinner.style.display = 'none';
            loginButtons.style.display = 'flex';
        }
    }, 500);
}

// ==================== 显示剩余天数信息 ====================
function showDaysLeftInfo() {
    const daysLeftInfo = document.getElementById('daysLeftInfo');
    const daysLeftText = document.getElementById('daysLeftText');
    
    if (studentInfo.daysLeft > 0) {
        daysLeftInfo.style.display = 'block';
        if (studentInfo.daysLeft === 1) {
            daysLeftText.textContent = `Votre accès est valide pour encore 1 jour.`;
        } else {
            daysLeftText.textContent = `Votre accès est valide pour encore ${studentInfo.daysLeft} jours.`;
        }
    } else if (studentInfo.daysLeft === -1) {
        daysLeftInfo.style.display = 'block';
        daysLeftText.textContent = `Votre accès est valide sans limitation de durée.`;
    } else {
        daysLeftInfo.style.display = 'none';
    }
}

// ==================== 更新测试卡片权限状态 ====================
function updateTestCardPermissions() {
    const multiYearCard = document.getElementById('multiYearCard');
    const tenYearCard = document.getElementById('tenYearCard');
    const nationalityCard = document.getElementById('nationalityCard');
    
    // 重置所有卡片
    multiYearCard.className = 'test-type-card';
    tenYearCard.className = 'test-type-card';
    nationalityCard.className = 'test-type-card';
    
    // 根据学生类型设置权限
    switch(studentInfo.type) {
        case 'm': // 只能访问多年卡
            multiYearCard.classList.add('allowed');
            tenYearCard.classList.add('disabled');
            nationalityCard.classList.add('disabled');
            break;
            
        case 'n': // 只能访问入籍
            multiYearCard.classList.add('disabled');
            tenYearCard.classList.add('disabled');
            nationalityCard.classList.add('allowed');
            break;
            
        case 'r': // 只能访问十年卡
            multiYearCard.classList.add('disabled');
            tenYearCard.classList.add('allowed');
            nationalityCard.classList.add('disabled');
            break;
            
        case 't': // 可以访问所有
            multiYearCard.classList.add('allowed');
            tenYearCard.classList.add('allowed');
            nationalityCard.classList.add('allowed');
            break;
    }
    
    // 更新选择消息
    const selectionMessage = document.getElementById('selectionMessage');
    if (studentInfo.type === 't') {
        selectionMessage.textContent = "Vous avez accès à tous les tests. Cliquez sur une option pour commencer.";
    } else {
        selectionMessage.textContent = "Votre compte a des restrictions d'accès. Seuls les tests autorisés sont activés.";
    }
}

// ==================== 检查权限并开始测试 ====================
function startTestIfAllowed(type) {
    console.log("尝试开始测试:", type, "学生类型:", studentInfo.type);
    
    // 检查是否有权限访问该测试类型
    let hasAccess = false;
    let errorTitle = "";
    let errorMessage = "";
    
    switch(studentInfo.type) {
        case 'm': // 只能访问多年卡
            hasAccess = (type === 'multi_year');
            if (!hasAccess) {
                errorTitle = "Accès refusé";
                errorMessage = "Votre compte est réservé au test 'Titre de Séjour 2-4 Ans' uniquement.\n\nCette simulation est réservée aux utilisateurs avec un compte 'Multi-year Residence Permit'.";
            }
            break;
            
        case 'n': // 只能访问入籍
            hasAccess = (type === 'nationality');
            if (!hasAccess) {
                errorTitle = "Accès refusé";
                errorMessage = "Votre compte est réservé au test 'Nationalité Française' uniquement.\n\nCette simulation est réservée aux utilisateurs avec un compte 'French Nationality'.";
            }
            break;
            
        case 'r': // 只能访问十年卡
            hasAccess = (type === 'ten_year');
            if (!hasAccess) {
                errorTitle = "Accès refusé";
                errorMessage = "Votre compte est réservé au test 'Carte de Résident 10 Ans' uniquement.\n\nCette simulation est réservée aux utilisateurs avec un compte '10-year Residence Card'.";
            }
            break;
            
        case 't': // 可以访问所有
            hasAccess = true;
            break;
            
        default:
            errorTitle = "Type inconnu";
            errorMessage = "Type d'étudiant non reconnu.\n\nStudent type not recognized.";
            hasAccess = false;
    }
    
    if (!hasAccess) {
        showAlert(errorTitle, errorMessage, 'error');
        return;
    }
    
    // 有权限，开始测试
    startTest(type);
}

// ==================== 开始测试 ====================
function startTest(type) {
    selectedTestType = type;
    
    // 显示加载动画
    const selectionContent = document.querySelector('.selection-content');
    const originalContent = selectionContent.innerHTML;
    selectionContent.innerHTML = `
        <div class="loading-spinner" style="display: block;">
            <div class="spinner"></div>
            <p>Préparation du test...</p>
        </div>
    `;
    
    setTimeout(() => {
        try {
            studentInfo.testType = selectedTestType;
            
            // 根据测试类型合并题库
            if (testTypes[selectedTestType].source === "both") {
                allQuestions = [...question_multi];
                if (typeof question_resident !== 'undefined' && question_resident.length > 0) {
                    allQuestions = allQuestions.concat(question_resident);
                }
                console.log("使用两个题库，总数:", allQuestions.length);
            } else {
                allQuestions = [...question_multi];
                console.log("使用question_multi题库，总数:", allQuestions.length);
            }
            
            if (allQuestions.length === 0) {
                throw new Error("题库为空，请检查题库文件");
            }
            
            // 隐藏选择模态窗口，显示测试
            document.getElementById('selectionModal').style.display = 'none';
            document.querySelector('.test-header').style.display = 'block';
            document.getElementById('testContainer').classList.add('show');
            document.querySelector('.test-footer').style.display = 'block';
            
            // 更新测试标题
            const testType = testTypes[selectedTestType];
            document.getElementById('testTitle').textContent = testType.name;
            document.getElementById('testSubtitle').textContent = testType.description;
            document.getElementById('testTypeInfo').textContent = testType.description;
            document.getElementById('footerTestInfo').textContent = 
                `${testType.name} - 40 questions - ${testType.duration} minutes`;
            
            initializeTest();
            
        } catch (error) {
            console.error("初始化测试失败:", error);
            showAlert("Erreur d'initialisation", error.message || "Erreur lors de l'initialisation du test.", 'error');
            // 恢复选择界面
            selectionContent.innerHTML = originalContent;
        }
    }, 1000);
}

// ==================== 根据主题分布选择题目 ====================
function selectQuestionsByTheme() {
    console.log("开始按主题分布选择题目...");
    
    // 1. 按主题分组题目
    const questionsByTheme = {};
    
    allQuestions.forEach((question) => {
        const theme = question.theme || question.category || "Autre";
        if (!questionsByTheme[theme]) {
            questionsByTheme[theme] = [];
        }
        questionsByTheme[theme].push(question);
    });
    
    // 2. 根据配置选择题目
    selectedQuestions = [];
    let totalSelected = 0;
    
    for (const [theme, targetCount] of Object.entries(themeDistribution)) {
        const themeQuestions = questionsByTheme[theme] || [];
        
        if (themeQuestions.length === 0) {
            console.warn(`警告: 主题 "${theme}" 中没有题目！`);
            continue;
        }
        
        if (themeQuestions.length <= targetCount) {
            selectedQuestions.push(...themeQuestions);
            totalSelected += themeQuestions.length;
        } else {
            const shuffled = shuffleArray([...themeQuestions]);
            const selected = shuffled.slice(0, targetCount);
            selectedQuestions.push(...selected);
            totalSelected += targetCount;
        }
    }
    
    // 3. 检查是否达到40题
    if (totalSelected < 40) {
        const needed = 40 - totalSelected;
        
        const selectedSet = new Set(selectedQuestions);
        const availableQuestions = allQuestions.filter(q => !selectedSet.has(q));
        
        if (availableQuestions.length > 0) {
            const shuffled = shuffleArray([...availableQuestions]);
            const toAdd = shuffled.slice(0, Math.min(needed, availableQuestions.length));
            selectedQuestions.push(...toAdd);
        }
    }
    
    // 如果题目太多，截取前40题
    if (selectedQuestions.length > 40) {
        selectedQuestions = selectedQuestions.slice(0, 40);
    }
    
    // 最终随机打乱所有题目顺序
    selectedQuestions = shuffleArray(selectedQuestions);
    
    console.log(`最终选择 ${selectedQuestions.length} 题`);
}

// Fisher-Yates 洗牌算法
function shuffleArray(array) {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
}

// ==================== 显示题目 ====================
function showQuestion(index) {
    if (!selectedQuestions[index]) {
        console.error("题目不存在:", index);
        return;
    }
    
    const question = selectedQuestions[index];
    
    document.getElementById('questionText').textContent = `${index + 1}. ${question.question}`;
    
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';
    
    if (!question.options || question.options.length === 0) {
        console.error("题目选项为空:", question);
        return;
    }
    
    // 为选项分配ABCD标签
    const optionLetters = ['A', 'B', 'C', 'D'];
    
    question.options.forEach((option, optionIndex) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option';
        if (userAnswers[index] === optionIndex) {
            optionDiv.classList.add('selected');
        }
        
        // 创建选项字母标签
        const letterSpan = document.createElement('span');
        letterSpan.className = 'option-letter';
        letterSpan.textContent = optionLetters[optionIndex];
        
        // 隐藏的radio input
        const input = document.createElement('input');
        input.type = 'radio';
        input.name = 'question';
        input.id = `option${index}_${optionIndex}`;
        input.value = optionIndex;
        if (userAnswers[index] === optionIndex) {
            input.checked = true;
        }
        
        const label = document.createElement('label');
        label.htmlFor = `option${index}_${optionIndex}`;
        
        // 添加选项内容
        label.appendChild(letterSpan);
        label.appendChild(document.createTextNode(option));
        
        optionDiv.appendChild(input);
        optionDiv.appendChild(label);
        
        optionDiv.addEventListener('click', () => {
            userAnswers[index] = optionIndex;
            showQuestion(index);
            updateQuestionCounter();
        });
        
        optionsContainer.appendChild(optionDiv);
    });
    
    document.getElementById('prevBtn').disabled = index === 0;
    document.getElementById('nextBtn').disabled = index === selectedQuestions.length - 1;
    
    document.getElementById('submitBtn').style.display = 
        (index === selectedQuestions.length - 1) ? 'block' : 'none';
}

// ==================== 计算主题表现 ====================
function calculateThemePerformance() {
    themePerformance = {};
    
    // 初始化每个主题的统计
    for (const theme in themeDistribution) {
        themePerformance[theme] = {
            total: 0,
            correct: 0,
            questions: []
        };
    }
    
    // 统计每个主题的答题情况
    selectedQuestions.forEach((question, index) => {
        const theme = question.theme || question.category || "Autre";
        
        if (themePerformance[theme]) {
            themePerformance[theme].total++;
            themePerformance[theme].questions.push({
                index: index,
                question: question,
                userAnswer: userAnswers[index],
                isCorrect: userAnswers[index] === question.answer
            });
            
            if (userAnswers[index] === question.answer) {
                themePerformance[theme].correct++;
            }
        }
    });
}

// ==================== 显示主题表现图表 ====================
function displayThemeCharts() {
    const chartsContainer = document.getElementById('themeChartsContainer');
    chartsContainer.innerHTML = '';
    
    for (const [theme, stats] of Object.entries(themePerformance)) {
        if (stats.total === 0) continue;
        
        const percentage = Math.round((stats.correct / stats.total) * 100);
        let fillClass = '';
        
        // 根据百分比设置颜色
        if (percentage >= 80) fillClass = 'excellent';
        else if (percentage >= 60) fillClass = 'good';
        else if (percentage >= 40) fillClass = 'average';
        else if (percentage >= 20) fillClass = 'poor';
        else fillClass = 'very-poor';
        
        const chartItem = document.createElement('div');
        chartItem.className = 'theme-chart-item';
        chartItem.innerHTML = `
            <div class="theme-chart-header">
                <div class="theme-name">${theme}</div>
                <div class="theme-score">${stats.correct}/${stats.total} (${percentage}%)</div>
            </div>
            <div class="theme-chart-bar">
                <div class="theme-chart-fill ${fillClass}" style="width: ${percentage}%"></div>
            </div>
            <div class="theme-chart-details">
                <span>Score: ${stats.correct}/${stats.total}</span>
                <span>${percentage}%</span>
            </div>
        `;
        
        chartsContainer.appendChild(chartItem);
    }
}

// ==================== 创建题目地图 ====================
function createQuestionMap() {
    const questionMap = document.getElementById('questionMap');
    questionMap.innerHTML = '';
    
    for (let i = 0; i < selectedQuestions.length; i++) {
        const mapItem = document.createElement('div');
        mapItem.className = 'map-item';
        mapItem.textContent = i + 1;
        
        // 设置状态
        if (userAnswers[i] === null) {
            mapItem.classList.add('unanswered');
        } else {
            const isCorrect = userAnswers[i] === selectedQuestions[i].answer;
            if (isCorrect) {
                mapItem.classList.add('correct');
            } else {
                mapItem.classList.add('incorrect');
            }
        }
        
        // 添加点击事件
        mapItem.addEventListener('click', () => {
            showQuestionReview(i);
        });
        
        questionMap.appendChild(mapItem);
    }
}

// ==================== 显示题目回顾 ====================
function showQuestionReview(index) {
    const questionReview = document.getElementById('questionReview');
    const question = selectedQuestions[index];
    const userAnswerIndex = userAnswers[index];
    const isCorrect = userAnswerIndex === question.answer;
    const optionLetters = ['A', 'B', 'C', 'D'];
    
    let reviewHTML = `
        <div class="review-header">
            <h4>Question ${index + 1} - ${question.theme || question.category || "Autre"}</h4>
            <span style="color: ${isCorrect ? 'var(--green)' : 'var(--red)'}; font-weight: 600;">
                ${isCorrect ? '✓ Correcte' : '✗ Incorrecte'}
            </span>
        </div>
        <div class="review-question">${question.question}</div>
        <div class="review-options">
    `;
    
    // 显示所有选项
    question.options.forEach((option, optionIndex) => {
        let optionClass = 'review-option';
        let badgeText = '';
        
        if (optionIndex === question.answer) {
            optionClass += ' correct-answer';
            badgeText = 'Réponse correcte';
        }
        
        if (optionIndex === userAnswerIndex) {
            optionClass += ' user-answer';
            if (optionIndex !== question.answer) {
                optionClass += ' incorrect';
                badgeText = 'Votre réponse (incorrecte)';
            } else {
                badgeText = 'Votre réponse (correcte)';
            }
        }
        
        reviewHTML += `
            <div class="${optionClass}">
                <span class="review-option-label">${optionLetters[optionIndex]}</span>
                <div class="review-option-text">${option}</div>
                ${badgeText ? `<span class="review-option-badge">${badgeText}</span>` : ''}
            </div>
        `;
    });
    
    reviewHTML += `
        </div>
    `;
    
    // 添加解释
    if (question.explanation) {
        reviewHTML += `
            <div class="review-explanation">
                <h5>Explication</h5>
                <p>${question.explanation}</p>
            </div>
        `;
    }
    
    questionReview.innerHTML = reviewHTML;
    questionReview.classList.add('active');
    
    // 滚动到回顾区域
    questionReview.scrollIntoView({ behavior: 'smooth' });
}

// ==================== 提交和评分 ====================
function submitTest() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    // 检查未答题
    const unanswered = userAnswers.filter(answer => answer === null).length;
    
    if (unanswered > 0) {
        showAlert("Questions non répondues", 
            `${unanswered} question(s) non répondues. Souhaitez-vous soumettre quand même?`, 
            'warning');
        
        // 创建一个确认按钮
        setTimeout(() => {
            const alertBtns = document.querySelector('.alert-btns');
            alertBtns.innerHTML = `
                <button class="btn" onclick="closeAlert();">Annuler</button>
                <button class="btn btn-primary" onclick="closeAlert(); proceedWithSubmission();">Soumettre</button>
            `;
        }, 100);
        return;
    }
    
    proceedWithSubmission();
}

function proceedWithSubmission() {
    calculateScore();
    displayResults();
}

function calculateScore() {
    let correct = 0;
    
    selectedQuestions.forEach((question, index) => {
        if (userAnswers[index] === question.answer) {
            correct++;
        }
    });
    
    currentScore = correct;
    currentPercentage = Math.round((correct / selectedQuestions.length) * 100);
    
    const testType = testTypes[selectedTestType];
    const threshold = testType.threshold;
    
    // ==================== 修改：显示通过/不通过，同时显示具体分数 ====================
    const passed = correct >= threshold;
    
    // 添加烟花或心碎效果
    if (passed) {
        currentScoreText = `🎉 Félicitations! Vous avez réussi le test! 🎉`;
    } else {
        currentScoreText = `💔 Désolé, vous n'avez pas réussi le test. 💔`;
    }
    
    // 计算主题表现
    calculateThemePerformance();
}

function displayResults() {
    document.getElementById('testContainer').style.display = 'none';
    
    // ==================== 修正：显示总分 ====================
    // 显示分数
    document.getElementById('scoreDisplay').style.display = 'block';
    document.getElementById('scoreDisplay').textContent = `${currentScore}/40`;
    
    document.getElementById('scoreText').textContent = currentScoreText;
    document.getElementById('scoreText').style.fontSize = '1.8rem';
    document.getElementById('scoreText').style.fontWeight = 'bold';
    document.getElementById('scoreText').style.marginTop = '10px';
    document.getElementById('scoreText').style.marginBottom = '20px';
    
    // 应用动画效果
    if (currentScoreText.includes("🎉")) {
        document.getElementById('scoreText').classList.add('fireworks');
    } else if (currentScoreText.includes("💔")) {
        document.getElementById('scoreText').classList.add('heartbreak');
    }
    
    // 显示进度条
    document.querySelector('.score-bar').style.display = 'block';
    setTimeout(() => {
        document.getElementById('scoreFill').style.width = currentPercentage + '%';
    }, 300);
    
    // 显示主题表现图表
    displayThemeCharts();
    
    // 创建题目地图
    createQuestionMap();
    
    document.getElementById('resultsContainer').classList.add('show');
    
    // 滚动到结果区域
    setTimeout(() => {
        document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
    }, 500);
}

// ==================== 其他功能 ====================
function restartTest() {
    showAlert("Recommencer le test", 
        "Voulez-vous vraiment recommencer le test? Vos réponses actuelles seront perdues.", 
        'warning');
    
    setTimeout(() => {
        const alertBtns = document.querySelector('.alert-btns');
        alertBtns.innerHTML = `
            <button class="btn" onclick="closeAlert();">Annuler</button>
            <button class="btn btn-primary" onclick="closeAlert(); proceedWithRestart();">Recommencer</button>
        `;
    }, 100);
}

function proceedWithRestart() {
    // 完全重新初始化
    currentQuestionIndex = 0;
    timeLeft = totalTime;
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    document.getElementById('resultsContainer').classList.remove('show');
    document.getElementById('questionReview').classList.remove('active');
    document.getElementById('testContainer').style.display = 'block';
    
    // 重新选择题目
    selectQuestionsByTheme();
    userAnswers = new Array(selectedQuestions.length).fill(null);
    
    document.getElementById('totalQuestions').textContent = selectedQuestions.length;
    document.getElementById('timerDisplay').textContent = "45:00";
    document.getElementById('timerProgress').style.width = "100%";
    document.getElementById('timerWarning').style.display = 'none';
    document.getElementById('timerCritical').style.display = 'none';
    
    showQuestion(currentQuestionIndex);
    updateQuestionCounter();
    
    startTimer();
    
    window.scrollTo(0, 0);
}

function showInstructions() {
    showAlert("Instructions du test",
        "1. 40 questions à choix multiples\n" +
        "2. Durée: 45 minutes\n" +
        "3. Seuil de réussite: 32/40 (80%)\n" +
        "4. Cliquez sur une réponse pour la sélectionner\n" +
        "5. Utilisez les boutons 'Précédente' et 'Suivante'\n" +
        "6. Le timer s'affiche en haut\n" +
        "7. Cliquez sur 'Terminer le test' quand vous avez fini\n\n" +
        "Bonne chance!", 'info');
}

function goBackToHome() {
    showAlert("Quitter le test", 
        "Êtes-vous sûr de vouloir quitter? Votre progression sera perdue.", 
        'warning');
    
    setTimeout(() => {
        const alertBtns = document.querySelector('.alert-btns');
        alertBtns.innerHTML = `
            <button class="btn" onclick="closeAlert();">Annuler</button>
            <button class="btn btn-primary" onclick="window.location.href='index.html';">Quitter</button>
        `;
    }, 100);
}

// ==================== 返回到登录页面 ====================
function goBackToLogin() {
    document.getElementById('selectionModal').style.display = 'none';
    document.getElementById('loginModal').style.display = 'flex';
}

// ==================== 导航函数 ====================
function nextQuestion() {
    if (currentQuestionIndex < selectedQuestions.length - 1) {
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
        updateQuestionCounter();
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion(currentQuestionIndex);
        updateQuestionCounter();
    }
}

function updateQuestionCounter() {
    const answeredCount = userAnswers.filter(answer => answer !== null).length;
    const answeredPercent = Math.round((answeredCount / selectedQuestions.length) * 100);
    
    document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
    document.getElementById('progressPercent').textContent = answeredPercent + '%';
    document.getElementById('progressFill').style.width = answeredPercent + '%';
}

// ==================== 计时器 ====================
function startTimer() {
    updateTimerDisplay();
    
    timerInterval = setInterval(() => {
        if (timeLeft > 0) {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft === 10 * 60) {
                document.getElementById('timerWarning').style.display = 'block';
            } else if (timeLeft === 5 * 60) {
                document.getElementById('timerWarning').style.display = 'none';
                document.getElementById('timerCritical').style.display = 'block';
            }
        } else {
            clearInterval(timerInterval);
            timerInterval = null;
            showAlert("Temps écoulé", "Le temps est écoulé! Votre test sera soumis automatiquement.", 'warning');
            submitTest();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    
    document.getElementById('timerDisplay').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const progressPercent = (timeLeft / totalTime) * 100;
    document.getElementById('timerProgress').style.width = `${progressPercent}%`;
}

// ==================== 初始化 ====================
function initializeTest() {
    // 重置所有状态
    currentQuestionIndex = 0;
    userAnswers = [];
    timeLeft = totalTime;
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    // 根据主题分布选择题目
    selectQuestionsByTheme();
    
    // 初始化用户答案数组
    userAnswers = new Array(selectedQuestions.length).fill(null);
    
    // 更新界面
    document.getElementById('totalQuestions').textContent = selectedQuestions.length;
    document.getElementById('timerDisplay').textContent = "45:00";
    document.getElementById('timerProgress').style.width = "100%";
    document.getElementById('timerWarning').style.display = 'none';
    document.getElementById('timerCritical').style.display = 'none';
    
    showQuestion(currentQuestionIndex);
    updateQuestionCounter();
    
    startTimer();
    
    window.scrollTo(0, 0);
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("页面加载完成");
    
    // 在登录页面按Enter键提交
    document.getElementById('studentPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            validateLogin();
        }
    });
});
</script>
</body>
</html>